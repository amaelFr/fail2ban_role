---
# tasks file for fail2ban
- name: Install fail2ban
  package:
    name: fail2ban
    state: latest

- name: Enable service
  service:
    name: fail2ban
    enabled: true


- name: Find previous/other local fail2ban conf
  find:
    paths: /etc/fail2ban
    patterns: "*.local"
    hidden: true
    recurse: true
  register: fail2ban_previous_conf
- name: Delete previous/other fail2Ban conf
  file:
    path: "{{ item.path }}"
    state: absent
  with_items: "{{ fail2ban_previous_conf.files }}"


- name: Configure local jails
  include_tasks: fail2ban_conf/conf.yml
  loop: "{{ fail2ban_jails_local|list }}"
  loop_control:
    loop_var: fail2ban_conf
  vars:
    fail2ban_confs: "{{ fail2ban_jails_local }}"
    fail2ban_conf_path: /etc/fail2ban/jail.local

- name: Configure jails
  include_tasks: fail2ban_conf/conf.yml
  loop: "{{ fail2ban_jails|list }}"
  loop_control:
    loop_var: fail2ban_conf
  vars:
    fail2ban_confs: "{{ fail2ban_jails }}"
    fail2ban_conf_base_path: /etc/fail2ban/jail.d/
